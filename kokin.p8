pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
t=0
egg=nil
game_state=nil

pet_colors={
	{main=11,shadow=3},
	{main=8,shadow=2},
	{main=10,shadow=9},
	{main=12,shadow=13}
}

pet_names={
	"terra",
	"jupiter",
	"zodiac",
	"saturn",
	"nebula",
	"winter",
	"atlas",
	"ceres",
	"gamma",
	"nova",
	"pyros",
}

pet_sex={"male","female"}

pet_data={}
active_pet=nil

function _init()
	reset_game()
end

function _update()
	if game_state=="hatch" then
		update_hatch(egg)
	elseif game_state=="room" then
		update_room()
	end
end

function _draw()
	cls(0)
	
	if game_state=="hatch" then
		draw_hatch(egg)
	elseif game_state=="room" then
		draw_room()
	end
end


function reset_game()
	pet_data=gen_pet_data()
	egg=init_hatch()
	init_room()
	game_state="room"
end

function gen_pet_data()
	local data={
		clrs=rnd(pet_colors),
		sex=rnd(pet_sex),
		name=rnd(pet_names)
	}
	
	return data
end
-->8
// hatch egg

function init_hatch()	
	t=0
	local egg={
		x=64,
		y=92,
		clrs=pet_data.clrs,
		cutscene=nil
	}
	return egg
end

function update_hatch(egg)
 if egg.cutscene==nil then
 	egg.cutscene=cocreate(update_hatch_cutscene)
 end
 
 if costatus(egg.cutscene)=="dead" then
 	egg.cutscene=nil
 	game_state="room"
 else
 	assert(coresume(egg.cutscene, egg))
 end
 
	t+=1
end

function update_hatch_cutscene(e)
	// shake egg
	for i=0,64 do
		e.frame=3
		if t%32<16 then
			e.frame=4
		end
		yield()
	end
	
	e.shake=true

	// crack egg
	for i=0,35 do
		if t%12==0 then
			e.frame+=1
		end
		yield()
	end
	
	e.shake=false
	e.frame=8
	e.shell={x=e.x,y=e.y,incy=-4}
	e.pet={x=e.x,y=e.y,incy=-4,clrs=pet_data.clrs}
	for i=0,8 do
	 e.pet.incy+=0.5
	 e.pet.y+=e.pet.incy
		e.shell.y*=0.95
		yield()
	end
	
	e.shell=nil
	while e.pet.y<=e.y-4 do
		e.pet.incy+=0.5
		e.pet.y+=e.pet.incy
		e.pet.y=min(e.pet.y,e.y)
		yield()
	end
	
	e.hide_bottom_shell=true
	
	while e.pet.y<e.y do
		e.pet.incy+=0.5
		e.pet.y+=e.pet.incy
		e.pet.y=min(e.pet.y,e.y)
		yield()
	end
end

function draw_hatch(e)
	local offsetx=0
	if e.shake then
		if t%12 < 4 then
			offsetx=-1
		elseif t%12 >8 then
			offsetx=1
		end
	end
	
	rectfill(0,96,128,128,1)

	if not e.hide_bottom_shell then
		pal({[11]=e.clrs.main, [3]=e.clrs.shadow})		
		spr(e.frame,e.x-4+offsetx,e.y-4)
		pal()
	end
	
	if e.shell then
		spr(9,e.shell.x-4,e.shell.y-4)
	end
	
	if e.pet then
		draw_hatched_pet(e.pet)
	end
	
	if e.shake then
		spr(66,e.x-4,e.y-16)
	end
end

function draw_hatched_pet(p)
	pal({[7]=p.clrs.main, [6]=p.clrs.shadow})		
	spr(1,p.x-4,p.y-4)
	pal()
end
-->8
// room for pet care/nursery
function init_room()
	active_pet={
		x=64,
		y=92,
		data=pet_data,
		stats={
			hunger=0,
		},
		age=0,
		hour=0,
	}
end

function update_room()
	// todo: tmp
	if btnp(ðŸ…¾ï¸) then
		tick_time(active_pet)
	end
end

function tick_time(p)
	if p.hour >= 2 then
		p.hour=0
		p.age+=1
		p.age=min(p.age,7)
	else
		p.hour+=1
	end
end

function draw_room()
	rectfill(0,96,128,128,1)

	draw_room_pet(active_pet)
	
	draw_pet_hud(active_pet,4,104)
	draw_time_hud(active_pet,4,4)
end

function draw_room_pet(p)
	pal({[7]=p.data.clrs.main, [6]=p.data.clrs.shadow})		
	spr(1,p.x-4,p.y-4)
	pal()
end

function draw_pet_hud(p,x,y)
	local sex_clr=12
	if p.data.sex=="female" then
		sex_clr=8
	end
	print(p.data.sex[1],x,y,sex_clr)
	print(p.data.name,x+6,y+0,7)
end

function draw_time_hud(p,x,y)
	// draw age hud
	line(x,y,x+7*8,y,5)

	for i=0,7 do
		local ev_radius=1
		if p.age==i then
			circfill(x+i*8,y,3,7)
			ev_radius=2
		else
			circfill(x+i*8,y,2,6)
		end
		
		if i%3==2 then
			circfill(x+i*8,y,ev_radius,1)
		end
	end
	
	// draw hour
	spr(80+p.hour,x+64,y-4)
	local hour_txt="morning"
	if p.hour==1 then
		hour_txt="noon"
	elseif p.hour==2 then
		hour_txt="evening"
	end
	print(hour_txt,x+74,y-2,5)
end
__gfx__
00000000000000000000000000776600000000000077660000776600007766000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000007b776600077660007b7766007b77660070000600000000000000000000000000000000000000000000000000000000000000000
0070070000000000000000000777b36007b776600777b3600770b060000000000000000000000000000000000000000000000000000000000000000000000000
000770000000000000000000777733660777b3607707336670070366000000000000000000776600000000000000000000000000000000000000000000000000
0007700000000000000000007b373366777733660037330000370000003700000037000007000060000000000000000000000000000000000000000000000000
007007000077770000000000733777667b3733667337706673377066733770667337706600000000000000000000000000000000000000000000000000000000
00000000001717000077770007777660733777660777766007777660077776600777766000000000000000000000000000000000000000000000000000000000
00000000006666000717177000666600066666600066660000666600006666000066660000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88000088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88077088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07171760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06777666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770077777700777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777778282777771177700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777787888277771177700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777788888277771177700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777778882777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777827777771177700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770077777700777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000700000007000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000077770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000070070000700700007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
700aa007700aa0077000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70aaaa07700aa0077009900700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70999907700000077099990700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7cccccc7700000077111111700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0711117007cccc700711117000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000077770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
